name: Credential Rotation Reminder

on:
  schedule:
    - cron: '0 14 1 * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  open-rotation-issue:
    name: Open Monthly Rotation Issue
    runs-on: ubuntu-latest
    steps:
      - name: Create rotation checklist issue (if missing)
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const ym = `${now.getUTCFullYear()}-${String(now.getUTCMonth() + 1).padStart(2, '0')}`;
            const title = `[security] credential rotation checklist ${ym}`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100,
            });

            if (issues.some((issue) => issue.title.toLowerCase() === title.toLowerCase())) {
              core.info(`Issue already exists: ${title}`);
              return;
            }

            const body = [
              '## Monthly Credential Rotation',
              '',
              'Complete this checklist and close the issue when done.',
              '',
              '### Provider/API Keys',
              '- [ ] Rotate OpenRouter API key',
              '- [ ] Rotate Anthropic API key',
              '- [ ] Rotate OpenAI API key',
              '- [ ] Rotate Brave Search API key (if used)',
              '- [ ] Rotate Google/MBTA/News API keys (if used)',
              '',
              '### Runtime/Auth',
              '- [ ] Rotate WhatsApp linked session credentials if needed (planned maintenance window)',
              '- [ ] Validate bot reconnection and message send/receive after rotation',
              '',
              '### GitHub / CI Secrets',
              '- [ ] Update repository secrets used by CI/deploy',
              '- [ ] Run `npm run check` after secret updates',
              '- [ ] Verify `Quality Gate` passes on a test PR',
              '',
              '### Deployment/Cloud (AWS)',
              '- [ ] Rotate/verify AWS credentials (prefer OIDC roles over long-lived keys)',
              '- [ ] Validate health endpoint and logs after deployment restart',
              '',
              '### Notes',
              '- Use `bash scripts/rotate-gh-secrets.sh` to push updated secrets from local env to GitHub Secrets.',
              '- Never commit secrets to git-tracked files.',
            ].join('\n');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });
